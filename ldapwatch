#!/bin/bash
if [[ -n "$VERBOSE" ]]; then
	set -x
fi

WORK_DIR=/var/run/ldapwatch

# print the file name for a given base at given URI
timestamp_filename() {
	URI_HASH="$(echo "$1" | sha1sum | cut -d ' ' -f 1)"
	BASE_HASH="$(echo "$2" | sha1sum | cut -d ' ' -f 1)"

	echo "$WORK_DIR/$URI_HASH/$BASE_HASH"
}

# print last known search time in LDAP generalized time format
get_last_timestamp() {
	BASE="$1"
	FILE_NAME="$(timestamp_filename "$URI" "$BASE")"
	DATE_FORMAT=%Y%m%d%H%M%SZ

	if [[ -f "$FILE_NAME" ]]; then
		date --utc --file="$FILE_NAME" +$DATE_FORMAT
	else
		date --utc --date=@0 +$DATE_FORMAT
	fi
}

# update mtime on a file for given URI and base
update_timestamp() {
	BASE="$1"
	FILE_NAME="$(timestamp_filename "$URI" "$BASE")"
	mkdir -p "$(dirname "$FILE_NAME")"
	touch "$FILE_NAME"
}

# delete timestamp file if command failed: force run next time
delete_timestamp() {
	BASE="$1"
	FILE_NAME="$(timestamp_filename "$URI" "$BASE")"
	rm -f "$FILE_NAME"
}

is_ldap_modified() {
	BASE="$1"
	TIMESTAMP=$2

	FOUND="$(ldapsearch -z 1 -LLL -x -H "$URI" -b "$BASE"
		"(modifyTimestamp>=$TIMESTAMP)" dn 2>/dev/null)"

	if [[ $? -ne 0 -a $? -ne 4 ]]; then
		ERR=$?
		echo "LDAP error $ERR returned by ldapsearch" >&2
		exit $ERR
	fi

	if [[ -n "$FOUND" ]]; then
		return 0
	else
		return 1
	fi
}
